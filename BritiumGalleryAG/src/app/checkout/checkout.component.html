<div class="checkout-container">
  <!-- Header Section -->
  <div class="checkout-header">
    <div class="header-content">
      <h1 class="main-title">Complete Your Order</h1>
      <p class="main-subtitle">Secure checkout with multiple payment options</p>
    </div>
  </div>

  <div class="checkout-content">
    <!-- LEFT SIDE: Checkout Form -->
    <div class="checkout-form-section">
      <form [formGroup]="checkoutForm" (ngSubmit)="submitCheckout()">
        
        <!-- Contact Information -->
        <div class="form-card">
          <div class="card-header">
            <div class="step-number">
              <i class="fa fa-user"></i>
            </div>
            <div class="step-info">
              <h2 class="step-title">Contact Information</h2>
              <p class="step-subtitle">Your personal details</p>
            </div>
          </div>
          
          <div class="form-content">
            <div class="form-group">
              <label for="name" class="form-label">Full Name</label>
              <input id="name" [value]="checkoutForm.get('name')?.value" disabled class="form-input disabled" placeholder="Name" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input id="email" [value]="checkoutForm.get('email')?.value" disabled class="form-input disabled" placeholder="Email" />
              </div>
              <div class="form-group">
                <label for="phone" class="form-label">Phone Number</label>
                <input id="phone" [value]="checkoutForm.get('phone')?.value" disabled class="form-input disabled" placeholder="Phone" />
              </div>
            </div>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="form-card">
          <div class="card-header">
            <div class="step-number">
              <i class="fa fa-location-dot"></i>
            </div>
            <div class="step-info">
              <h2 class="step-title">Delivery Address</h2>
              <p class="step-subtitle">Where should we deliver your order?</p>
            </div>
          </div>

          <div class="form-content">
            <div class="form-group" *ngIf="mainAddressDTO">
              <label for="mainAddress" class="form-label">Main Address</label>
              <div class="address-display">
                <input id="mainAddress" type="text" [value]="mainAddress" readonly class="form-input address-input" />
                <button type="button" class="edit-btn" (click)="editAddress()">
                  <i class="fa fa-pen"></i>
                  Edit
                </button>
              </div>
            </div>

            <div class="form-group">
              <button type="button" class="address-toggle-btn" (click)="openAddressModal()">
                <i class="fa fa-map-marker-alt"></i>
                Manage All Addresses
              </button>
            </div>
          </div>
        </div>

        <!-- Delivery Method -->
        <div class="form-card">
          <div class="card-header">
            <div class="step-number">
              <i class="fa fa-truck"></i>
            </div>
            <div class="step-info">
              <h2 class="step-title">Delivery Method</h2>
              <p class="step-subtitle">Choose your preferred delivery speed</p>
            </div>
          </div>

          <div class="form-content">
            <!-- Delivery Type Selection -->
            <div class="form-group">
              <label for="deliveryType" class="form-label">Delivery Type</label>
              <div class="delivery-type-selector">
                <div class="delivery-option" 
                     [class.selected]="checkoutForm.get('deliveryType')?.value === 'standard'"
                     [class.disabled]="suggestedMethod !== 'standard'"
                     (click)="onDeliveryTypeChange('standard')">
                  <div class="delivery-icon">
                    <i class="fa fa-truck"></i>
                  </div>
                  <div class="delivery-info">
                    <h4>Standard Delivery</h4>
                    <p>Same city delivery</p>
                  </div>
                </div>
                
                <div class="delivery-option" 
                     [class.selected]="checkoutForm.get('deliveryType')?.value === 'express'"
                     [class.disabled]="suggestedMethod !== 'express'"
                     (click)="onDeliveryTypeChange('express')">
                  <div class="delivery-icon">
                    <i class="fa fa-bolt"></i>
                  </div>
                  <div class="delivery-info">
                    <h4>Express Delivery</h4>
                    <p>Inter-city delivery</p>
                  </div>
                </div>
                
                <div class="delivery-option" 
                     [class.selected]="checkoutForm.get('deliveryType')?.value === 'ship'"
                     [class.disabled]="suggestedMethod !== 'ship'"
                     (click)="onDeliveryTypeChange('ship')">
                  <div class="delivery-icon">
                    <i class="fa fa-ship"></i>
                  </div>
                  <div class="delivery-info">
                    <h4>Ship Delivery</h4>
                    <p>International delivery</p>
                  </div>
                </div>
              </div>
              
              <div *ngIf="suggestedMethod" class="suggestion-badge">
                <i class="fa fa-lightbulb"></i>
                Suggested: {{ suggestedMethod.charAt(0).toUpperCase() + suggestedMethod.slice(1) }} Delivery
              </div>
            </div>

            <!-- Auto-selected Delivery Notice -->
            <div class="form-group" *ngIf="methodAutoChanged">
              <div class="shipping-notice">
                <i class="fa fa-info-circle notice-icon"></i>
                <span class="notice-text">
                  Delivery method changed to <strong>{{ (checkoutForm.get('deliveryType')?.value || '').charAt(0).toUpperCase() + (checkoutForm.get('deliveryType')?.value || '').slice(1) }}</strong>
                  based on your address distance.
                </span>
              </div>
            </div>

            <!-- Speed Type Selection -->
            <div class="form-group" *ngIf="getAvailableSpeedTypes().length > 0">
              <label class="form-label">Speed Options</label>
              <div class="speed-options">
                <div *ngFor="let option of getAvailableSpeedTypes()" 
                     class="speed-option" 
                     [class.selected]="checkoutForm.get('speedType')?.value === option.speedType"
                     (click)="onSpeedTypeChange(option.speedType!)">
                  <div class="speed-icon">
                    <i [class]="getDeliveryIconClass(option.deliveryType || '', option.speedType || '')"></i>
                  </div>
                  <div class="speed-info">
                    <div class="speed-name">{{ getDeliveryDisplayName(option) }}</div>
                    <div class="speed-description">{{ getDeliveryDescription(option) }}</div>
                  </div>
                  <div class="speed-price" *ngIf="calculatedDistance > 0">
                    <div class="price-amount">{{ calculateFeeForOption(option) | number:'1.0-0' }} MMK</div>
                    <div class="distance-info">{{ calculatedDistance | number:'1.1' }} km</div>
                  </div>
                </div>
              </div>
              

            </div>

            <!-- Delivery Information -->
            <div class="form-group" *ngIf="selectedDelayRange && calculatedDistance > 0">
              <div class="delivery-info">
                <div class="info-header">
                  <i class="fa fa-info-circle"></i>
                  <span>Delivery Summary</span>
                </div>
                <div class="info-content">
                  <div class="info-row">
                    <span class="info-label">Distance:</span>
                    <span class="info-value">{{ calculatedDistance | number:'1.1' }} km</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Estimated Delivery:</span>
                    <span class="info-value">{{ selectedDelayRange }}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Delivery Fee:</span>
                    <span class="info-value fee">{{ deliveryFee | number:'1.0-0' }} MMK</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="place-order-btn" [disabled]="!isFormValid()">
          <i class="fa fa-shopping-cart btn-icon"></i>
          <span>Place Order & Continue to Payment</span>
        </button>
      </form>
    </div>

    <!-- RIGHT SIDE: Summary -->
    <div class="cart-summary-section">
      <!-- Promo Code -->
      <div class="summary-card promo-card">
        <div class="card-header-small">
          <div class="promo-icon">
            <i class="fa fa-tag"></i>
          </div>
          <div>
            <h3 class="card-title">Promo Code</h3>
            <p class="card-subtitle">Apply discount code</p>
          </div>
        </div>
        <div class="promo-input-group">
          <input type="text" [(ngModel)]="promoCode" placeholder="Enter discount code" class="promo-input">
          <button class="apply-btn" (click)="applyPromo()">Apply Code</button>
        </div>
        <!-- Feedback messages -->
        <p class="text-success" *ngIf="couponSuccess">
          Coupon applied.
          <span *ngIf="discountType === 'Percentage'">
            Discount: {{ discountValue }}% (MMK {{ appliedDiscount | number:'1.0-0' }})
          </span>
          <span *ngIf="discountType === 'Fixed Amount'">
            Discount: MMK {{ appliedDiscount | number:'1.0-0' }}
          </span>
        </p>
        <p class="text-danger" *ngIf="couponError">{{ couponError }}</p>
      </div>

      <!-- Order Summary -->
      <div class="summary-card order-summary-card">
        <div class="card-header-small">
          <div class="summary-icon">
            <i class="fa fa-cart-shopping"></i>
          </div>
          <div>
            <h3 class="card-title">Order Summary</h3>
            <p class="card-subtitle">Review your items</p>
          </div>
        </div>
        
        <div class="summary-content">
          <div class="summary-row">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value">MMK {{ getSubtotal() | number:'1.0-0' }}</span>
          </div>
          <div class="summary-row text-success" *ngIf="appliedDiscount > 0">
            <span class="summary-label">Discount</span>
            <span class="summary-value">
              <ng-container *ngIf="discountType === 'Percentage'">
                - {{ discountValue }}% (MMK {{ appliedDiscount | number:'1.0-0' }})
              </ng-container>
              <ng-container *ngIf="discountType === 'Fixed Amount'">
                - MMK {{ appliedDiscount | number:'1.0-0' }}
              </ng-container>
            </span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Items</span>
            <span class="summary-badge">{{ getTotalItems() }} items</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Delivery Fee</span>
            <span class="summary-value">MMK {{ deliveryFee | number:'1.0-0' }}</span>
          </div>
          <div class="summary-row" *ngIf="selectedDelayRange">
            <span class="summary-label">Estimated Delivery</span>
            <span class="summary-value">{{ selectedDelayRange }}</span>
          </div>
          <div class="summary-total">
            <div class="total-row">
              <span class="total-label">Total</span>
              <span class="total-value">MMK {{ getTotalCost() | number:'1.0-0' }}</span>
            </div>
          </div>
        </div>
        <div class="view-cart-link">
          <a href="#" (click)="$event.preventDefault(); showOrderItemsModal = true;">
            <i class="fa fa-eye"></i>
            View Cart Items
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for All Addresses -->
  <div class="modal-backdrop" *ngIf="isAddressModalOpen">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">My Addresses</h3>
        <button class="close-btn" (click)="closeAddressModal()">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div *ngFor="let address of addresses" class="address-card">
          <p class="address-text">
            {{ address.houseNumber }}, {{ address.street }}, {{ address.wardName }}, {{ address.township }},
            {{ address.city }}, {{ address.state }}, {{ address.country }},
            {{ address.postalCode || 'N/A' }}
          </p>

          <button *ngIf="address.id !== mainAddressId"
                  class="set-main-btn"
                  (click)="setAsMain(address.id!)"
                  title="Set as Main Address">
            <i class="fa fa-star"></i> Set as Main
          </button>

          <span *ngIf="address.id === mainAddressId" class="main-label" title="Main Address">
            <i class="fa fa-home"></i> Main Address
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Items Modal -->
  <div class="modal-backdrop" *ngIf="showOrderItemsModal">
    <div class="modal-content order-items-modal">
      <div class="modal-header">
        <h3 class="modal-title">Cart Items</h3>
        <button class="close-btn" (click)="showOrderItemsModal = false">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <ul class="order-items-list">
          <li *ngFor="let item of items" class="order-item-detail">
            <img *ngIf="variantDetails[item.productVariantId]?.imageUrls?.length" 
                 [src]="variantDetails[item.productVariantId].imageUrls[0]" 
                 width="60" style="margin-right: 12px;" />
            <div>
              <div><strong>{{variantDetails[item.productVariantId]?.productName || item.productName}}</strong> 
                   (SKU: {{variantDetails[item.productVariantId]?.sku || item.productVariantId}})</div>
              <div *ngFor="let attr of variantDetails[item.productVariantId]?.attributes | keyvalue">
                <span style="font-size: 13px;">{{attr.key}}: {{attr.value}}</span>
              </div>
              <div>Quantity: {{item.quantity}}</div>
              <div class="price-display">
                <ng-container *ngIf="getItemDiscountPercent(item) && getItemDiscountedPrice(item) < item.price; else noDiscount">
                  <span style="text-decoration: line-through; color: #888; font-size: 0.9em; margin-right: 6px;">
                    {{item.price | number:'1.0-0'}} MMK
                  </span>
                  <span style="background: #f5f5f5; color: #222; font-size: 0.85em; font-weight: 600; border-radius: 6px; padding: 1px 6px; margin-right: 6px;">
                    -{{getItemDiscountPercent(item) | number:'1.0-0'}}%
                  </span>
                  <span style="color: #111; font-weight: 700; font-size: 1.05em;">
                    {{getItemDiscountedPrice(item) | number:'1.0-0'}} MMK
                  </span>
                </ng-container>
                <ng-template #noDiscount>
                  {{getItemDiscountedPrice(item) | number:'1.0-0'}} MMK
                </ng-template>
              </div>
              <div class="item-total">
                Total: {{item.quantity * getItemDiscountedPrice(item) | number:'1.0-0'}} MMK
              </div>
              
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- <div *ngIf="showCouponAppliedPopup" class="success-message" style="margin-bottom: 16px;">
    Coupon applied! Discount: 
    <span *ngIf="discountType === 'Percentage'">
      {{ discountValue }}% (MMK {{ appliedDiscount | number:'1.0-0' }})
    </span>
    <span *ngIf="discountType === 'Fixed Amount'">
      MMK {{ appliedDiscount | number:'1.0-0' }}
    </span>
  </div> -->
</div>
