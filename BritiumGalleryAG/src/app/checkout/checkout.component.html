<div class="checkout-container">

  <div class="checkout-content">
    <!-- LEFT SIDE: Checkout Form -->
    <div class="checkout-form-section">
      <form [formGroup]="checkoutForm" (ngSubmit)="submitCheckout()">
        
        <!-- Contact Information -->
        <div class="form-card">
          <div class="card-header">
            <div class="step-number">1</div>
            <div class="step-info">
              <h2 class="step-title">Contact Information</h2>
              <p class="step-subtitle">Your personal details</p>
            </div>
          </div>
          
          <div class="form-content">
            <div class="form-group">
              <label for="name" class="form-label">Full Name</label>
              <input id="name" [value]="checkoutForm.get('name')?.value" disabled class="form-input disabled" placeholder="Name" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="email" class="form-label">Email</label>
                <input id="email" [value]="checkoutForm.get('email')?.value" disabled class="form-input disabled" placeholder="Email" />
              </div>
              <div class="form-group">
                <label for="phone" class="form-label">Phone Number</label>
                <input id="phone" [value]="checkoutForm.get('phone')?.value" disabled class="form-input disabled" placeholder="Phone" />
              </div>
            </div>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="form-card">
          <div class="card-header">
            <div class="step-number step-2">2</div>
            <div class="step-info">
              <h2 class="step-title">Delivery Address</h2>
              <p class="step-subtitle">Where should we deliver your order?</p>
            </div>
          </div>

          <div class="form-content">
            <div class="form-group" *ngIf="mainAddressDTO">
              <label for="mainAddress" class="form-label">Main Address</label>
              <div class="address-display">
                <input id="mainAddress" type="text" [value]="mainAddress" readonly class="form-input address-input" />
                <button type="button" class="edit-btn" (click)="editAddress()">
                  <span class="edit-icon">‚úèÔ∏è</span>
                  Edit
                </button>
              </div>
            </div>

            <div class="form-group">
              <button type="button" class="address-toggle-btn" (click)="openAddressModal()">
                <span class="address-icon">üìç</span>
                Show All Addresses
              </button>
            </div>
          </div>
        </div>

        <!-- Shipping Method -->
        <div class="form-card">
          <div class="card-header">
            <div class="step-number step-3">3</div>
            <div class="step-info">
              <h2 class="step-title">Shipping Method</h2>
              <p class="step-subtitle">Choose your preferred delivery speed</p>
            </div>
          </div>

          <div class="form-content">
            <div class="form-group">
              <label for="shippingMethod" class="form-label">Choose Shipping Method</label>
              <select id="shippingMethod" formControlName="shippingMethod" class="form-select">
                <option value="Standard" [disabled]="suggestedMethod !== 'Standard'">
                   Standard Shipping 
                </option>
                <option value="Express" [disabled]="suggestedMethod !== 'Express'">
                   Express Shipping 
                </option>
                <option value="Ship" [disabled]="suggestedMethod !== 'Ship'">
                   Ship Shipping 
                </option>
              </select>
            </div>

            <!-- Auto-selected Shipping Notice -->
            <div class="form-group" *ngIf="methodAutoChanged">
              <div class="shipping-notice">
                <span class="notice-icon">üì¢</span>
                <span class="notice-text">
                  Delivery method changed to <strong>{{ checkoutForm.get('shippingMethod')?.value }}</strong>
                  based on your address distance.
                </span>
              </div>
            </div>

            <!-- Standard Provider -->
            <div class="form-group" *ngIf="checkoutForm.get('shippingMethod')?.value === 'Standard'">
              <label for="standardName" class="form-label">Choose Standard Provider</label>
              <select id="standardName" formControlName="standardName" class="form-select">
                <option value="" disabled selected>Select a provider</option>
                <option *ngFor="let standard of standardOptions" [value]="standard.name">{{ standard.name }}</option>
              </select>
            </div>

            <!-- Express Provider -->
            <div class="form-group" *ngIf="checkoutForm.get('shippingMethod')?.value === 'Express'">
              <label for="expressName" class="form-label">Choose Express Provider</label>
              <select id="expressName" formControlName="expressName" class="form-select">
                <option value="" disabled selected>Select a provider</option>
                <option *ngFor="let express of expressOptions" [value]="express.name">{{ express.name }}</option>
              </select>
            </div>

            <!-- Ship Provider -->
            <div class="form-group" *ngIf="checkoutForm.get('shippingMethod')?.value === 'Ship'">
              <label for="shipName" class="form-label">Choose Ship Provider</label>
              <select id="shipName" formControlName="shipName" class="form-select">
                <option value="" disabled selected>Select a provider</option>
                <option *ngFor="let ship of shipOptions" [value]="ship.name">{{ ship.name }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Payment -->
        <div class="form-card">
          <div class="card-header">
            <div class="step-number step-4">4</div>
            <div class="step-info">
              <h2 class="step-title">Payment Method</h2>
              <p class="step-subtitle">Choose how you'd like to pay</p>
            </div>
          </div>

          <div class="form-content">
            <div class="form-group">
              <label for="paymentType" class="form-label">Select Payment Method</label>
              <select id="paymentType" formControlName="paymentType" class="form-select payment-method-select">
                <option value="CreditCard">Credit Card</option>
                <option *ngFor="let payment of payments" [value]="payment.name">{{ payment.name }}</option>
              </select>
            </div>

            <!-- Credit Card Fields -->
            <div class="payment-fields" *ngIf="checkoutForm.get('paymentType')?.value === 'CreditCard'">
              <div class="form-group">
                <label class="form-label">Card Number</label>
                <input formControlName="cardNumber" placeholder="1234 5678 9012 3456" class="form-input" />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">Expiry Date</label>
                  <input formControlName="expiry" placeholder="MM/YY" class="form-input" />
                </div>
                <div class="form-group">
                  <label class="form-label">CVV</label>
                  <input formControlName="cvv" placeholder="123" class="form-input" />
                </div>
              </div>
            </div>

            <!-- QR Code & Payment Instructions -->
            <div class="payment-instructions" *ngIf="checkoutForm.get('paymentType')?.value && checkoutForm.get('paymentType')?.value !== 'CreditCard'">
              
              <!-- QR Code Section -->
              <div class="qr-code-section">
                <div class="qr-header">
                  <span class="qr-icon">üì±</span>
                  <div>
                    <h4 class="qr-title">Scan QR Code to Pay</h4>
                    <p class="qr-subtitle">Use your {{ checkoutForm.get('paymentType')?.value }} app to scan and pay</p>
                  </div>
                </div>

                <div class="qr-container">
                  <div class="qr-code-display">
                    <!-- QR Code Image -->
                    <div class="qr-code-wrapper">
                      <img [src]="getQRCodeUrl()" [alt]="checkoutForm.get('paymentType')?.value + ' QR Code'" class="qr-code-image" />
                    </div>
                    
                    <!-- Payment Details -->
                    <div class="payment-details">
                      <div class="detail-row">
                        <span class="detail-label">Amount:</span>
                        <span class="detail-value amount">MMK {{ getTotalCost() | number:'1.0-0' }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="detail-label">Method:</span>
                        <span class="detail-value">{{ checkoutForm.get('paymentType')?.value }}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Payment Steps -->
                  <div class="payment-steps">
                    <div class="step-header">
                      <span class="steps-icon">üìã</span>
                      <h4 class="steps-title">Payment Steps</h4>
                    </div>
                    
                    <div class="instruction-steps">
                      <div class="step-item">
                        <span class="step-number-small">1</span>
                        <span class="step-text">Open your {{ checkoutForm.get('paymentType')?.value }} app</span>
                      </div>
                      
                      <div class="step-item">
                        <span class="step-number-small">2</span>
                        <span class="step-text">Scan the QR code above</span>
                      </div>
                      
                      <div class="step-item">
                        <span class="step-number-small">3</span>
                        <span class="step-text">Complete the payment of <strong>MMK {{ getTotalCost() | number:'1.0-0' }}</strong></span>
                      </div>
                      
                      <div class="step-item">
                        <span class="step-number-small">4</span>
                        <span class="step-text">Take a screenshot of the successful transaction</span>
                      </div>
                      
                      <div class="step-item">
                        <span class="step-number-small">5</span>
                        <span class="step-text">Upload the receipt below for verification</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Receipt Upload Section -->
              <div class="receipt-upload-section">
                <div class="upload-header">
                  <span class="upload-icon">üìÑ</span>
                  <div>
                    <h4 class="upload-title">Upload Payment Receipt</h4>
                    <p class="upload-subtitle">Upload screenshot of your payment transaction</p>
                  </div>
                </div>

                <div class="upload-area" (click)="triggerFileInput()" [class.has-file]="selectedReceiptFile">
                  <input type="file" #fileInput (change)="onReceiptFileSelected($event)" accept="image/*" style="display: none;">
                  
                  <div class="upload-content" *ngIf="!selectedReceiptFile">
                    <div class="upload-icon-large">üìÅ</div>
                    <div class="upload-text">
                      <p class="upload-main-text">Click to upload receipt</p>
                      <p class="upload-sub-text">PNG, JPG up to 5MB</p>
                    </div>
                  </div>

                  <div class="uploaded-file" *ngIf="selectedReceiptFile">
                    <div class="file-info">
                      <span class="file-icon">‚úÖ</span>
                      <div class="file-details">
                        <p class="file-name">{{ selectedReceiptFile.name }}</p>
                        <p class="file-size">{{ selectedReceiptFile.size | number:'1.0-0' }} bytes</p>
                      </div>
                    </div>
                    <button type="button" class="remove-file-btn" (click)="removeReceiptFile($event)">
                      <span>üóëÔ∏è</span>
                    </button>
                  </div>
                </div>

                <div class="verification-notice">
                  <span class="notice-icon">‚è≥</span>
                  <span class="notice-text">Your order will be processed after admin verifies the payment receipt</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="place-order-btn" [disabled]="!isFormValid()">
          <span class="btn-icon">üõí</span>
          <span *ngIf="checkoutForm.get('paymentType')?.value === 'CreditCard'">Complete Order</span>
          <span *ngIf="checkoutForm.get('paymentType')?.value !== 'CreditCard' && checkoutForm.get('paymentType')?.value">Submit Order for Verification</span>
          <span *ngIf="!checkoutForm.get('paymentType')?.value">Complete Order</span>
        </button>
      </form>
    </div>

    <!-- RIGHT SIDE: Summary -->
    <div class="cart-summary-section">
      <!-- Promo Code -->
    <div class="summary-card promo-card">
      <div class="card-header-small">
        <div class="promo-icon">üè∑Ô∏è</div>
        <div>
          <h3 class="card-title">Promo Code</h3>
          <p class="card-subtitle">Apply discount code</p>
        </div>
      </div>
      <div class="promo-input-group">
        <input type="text" [(ngModel)]="promoCode" placeholder="Enter discount code" class="promo-input">
        <button class="apply-btn" (click)="applyPromo()">Apply Code</button>
      </div>
      <!-- Feedback messages -->
      <p class="text-success" *ngIf="couponSuccess">
        Coupon applied.
        <span *ngIf="discountType === 'Percentage'">
          Discount: {{ discountValue }}% (MMK {{ appliedDiscount | number:'1.0-0' }})
        </span>
        <span *ngIf="discountType === 'Fixed Amount'">
          Discount: MMK {{ appliedDiscount | number:'1.0-0' }}
        </span>
      </p>
      <p class="text-danger" *ngIf="couponError">{{ couponError }}</p>
    </div>

    <!-- Order Summary -->
    <div class="summary-card order-summary-card">
      <div class="card-header-small">
        <div class="summary-icon">üõçÔ∏è</div>
        <div>
          <h3 class="card-title">Order Summary</h3>
          <p class="card-subtitle">Review your order</p>
        </div>
      </div>
      
      <div class="summary-content">
        <div class="summary-row">
          <span class="summary-label">Subtotal</span>
          <span class="summary-value">MMK {{ getSubtotal() | number:'1.0-0' }}</span>
        </div>

        <!-- Discount line if applied -->
        <div class="summary-row text-success" *ngIf="appliedDiscount > 0">
          <span class="summary-label">Discount</span>
          <span class="summary-value">
            <ng-container *ngIf="discountType === 'Percentage'">
              - {{ discountValue }}% (MMK {{ appliedDiscount | number:'1.0-0' }})
            </ng-container>
            <ng-container *ngIf="discountType === 'Fixed Amount'">
              - MMK {{ appliedDiscount | number:'1.0-0' }}
            </ng-container>
          </span>
        </div>

        <div class="summary-row">
          <span class="summary-label">Items</span>
          <span class="summary-badge">{{ getTotalItems() }} items</span>
        </div>

        <div class="summary-row">
          <span class="summary-label">Delivery Fee</span>
          <span class="summary-value">MMK {{ deliveryFee | number:'1.0-0' }}</span>
        </div>

        <div class="summary-row" *ngIf="selectedDelayRange">
          <span class="summary-label">Estimated Delivery</span>
          <span class="delivery-badge">{{ selectedDelayRange }}</span>
        </div>

        <div class="summary-total">
          <div class="total-row">
            <span class="total-label">Total</span>
            <span class="total-value">MMK {{ getTotalCost() | number:'1.0-0' }}</span>
          </div>
        </div>
      </div>
    </div>

      <!-- Admin Verification Panel (Show only if receipt uploaded) -->
      <div class="summary-card admin-panel" *ngIf="selectedReceiptFile && isAdminView">
        <div class="card-header-small">
          <div class="admin-icon">üë®‚Äçüíº</div>
          <div>
            <h3 class="card-title">Admin Verification</h3>
            <p class="card-subtitle">Payment verification required</p>
          </div>
        </div>
        
        <div class="admin-content">
          <div class="verification-item">
            <span class="verification-label">Expected Amount:</span>
            <span class="verification-amount">MMK {{ getTotalCost() | number:'1.0-0' }}</span>
          </div>
          
          <div class="verification-item">
            <span class="verification-label">Payment Method:</span>
            <span class="verification-method">{{ checkoutForm.get('paymentType')?.value }}</span>
          </div>
          
          <div class="verification-item">
            <span class="verification-label">Receipt Status:</span>
            <span class="verification-status pending">Pending Review</span>
          </div>

          <div class="admin-actions">
            <button type="button" class="verify-btn approve" (click)="approvePayment()">
              ‚úÖ Approve Payment
            </button>
            <button type="button" class="verify-btn reject" (click)="rejectPayment()">
              ‚ùå Reject Payment
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for All Addresses -->
  <div class="modal-backdrop" *ngIf="isAddressModalOpen">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">My Addresses</h3>
        <button class="close-btn" (click)="closeAddressModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div *ngFor="let address of addresses" class="address-card">
          <p class="address-text">
            {{ address.houseNumber }}, {{ address.street }}, {{ address.wardName }}, {{ address.township }},
            {{ address.city }}, {{ address.state }}, {{ address.country }},
            {{ address.postalCode || 'N/A' }}
          </p>

          <button *ngIf="address.id !== mainAddressId"
                  class="set-main-btn"
                  (click)="setAsMain(address.id!)"
                  title="Set as Main Address">
            ‚≠ê Set as Main
          </button>

          <span *ngIf="address.id === mainAddressId" class="main-label" title="Main Address">
            üè† Main Address
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt Preview Modal -->
  <div class="modal-backdrop" *ngIf="showReceiptPreview">
    <div class="modal-content receipt-modal">
      <div class="modal-header">
        <h3 class="modal-title">Payment Receipt</h3>
        <button class="close-btn" (click)="closeReceiptPreview()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="receipt-preview">
          <img [src]="receiptPreviewUrl" alt="Payment Receipt" class="receipt-image">
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showCouponAppliedPopup" class="success-message" style="margin-bottom: 16px;">
    Coupon applied! Discount: 
    <span *ngIf="discountType === 'Percentage'">
      {{ discountValue }}% (MMK {{ appliedDiscount | number:'1.0-0' }})
    </span>
    <span *ngIf="discountType === 'Fixed Amount'">
      MMK {{ appliedDiscount | number:'1.0-0' }}
    </span>
  </div>
</div>
