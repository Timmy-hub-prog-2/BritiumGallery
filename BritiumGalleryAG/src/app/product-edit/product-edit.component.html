<div class="product-editor-clean">
  <!-- Header Section -->
  <div class="header-section">
    <div class="header-content">
      <div class="product-info-header">
        <ng-container *ngIf="product as p; else loadingProductHeader">
          <div class="product-avatar-clean">
            <img
              *ngIf="p.basePhotoUrl"
              [src]="p.basePhotoUrl"
              alt="Product Base Photo"
              class="avatar-img"
            />
            <div *ngIf="!p.basePhotoUrl" class="avatar-placeholder-clean">
              <mat-icon>inventory_2</mat-icon>
            </div>
          </div>
          <div class="product-details-clean">
            <h1 class="product-title-clean">{{ p.name }}</h1>
            <p class="product-description-clean">
              {{ p.description || "Manage variants and inventory" }}
            </p>
            <div class="product-stats-clean">
              <div class="stat-item">
                <span class="stat-number">{{ getTotalStock() }}</span>
                <span class="stat-label">Total Stock</span>
              </div>
              <div class="stat-divider"></div>
              <div class="stat-item">
                <span class="stat-number">{{ dataSource.data.length }}</span>
                <span class="stat-label">Variants</span>
              </div>
            </div>
          </div>
        </ng-container>
        <ng-template #loadingProductHeader>
          <div class="product-avatar-clean loading">
            <mat-icon>inventory_2</mat-icon>
          </div>
          <div class="product-details-clean">
            <h1 class="product-title-clean">Loading Product...</h1>
            <p class="product-description-clean">
              Please wait while we load the product information
            </p>
          </div>
        </ng-template>
      </div>

      <div class="header-actions">
        <button
          mat-stroked-button
          (click)="editProductInfo()"
          class="action-btn-clean edit-product"
        >
          <mat-icon>edit</mat-icon>
          Edit Product
        </button>
        <button
          mat-stroked-button
          (click)="showProductHistory()"
          class="action-btn-clean product-history"
        >
          <mat-icon>history</mat-icon>
          Product History
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content-clean">
    <!-- Toolbar -->
    <div class="toolbar-clean">
      <div class="toolbar-left">
        <h2 class="section-title-clean">Product Variants</h2>
        <span class="variants-count">{{ dataSource.data.length }} items</span>
      </div>

      <div class="toolbar-right">
        <button
          mat-mini-fab
          (click)="addNewVariant()"
          matTooltip="Quick Add"
          class="quick-add-clean"
        >
          <mat-icon>add</mat-icon>
        </button>
      </div>
    </div>

    <!-- Variants Table -->
    <div class="table-container-clean">
      <table
        mat-table
        [dataSource]="dataSource"
        matSort
        class="variants-table-clean"
      >
        <!-- ID Column -->
        <ng-container matColumnDef="id">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            class="header-cell-clean"
          >
            <div class="header-content-clean">
              <mat-icon class="header-icon">tag</mat-icon>
              <span>ID</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let variant" class="data-cell-clean">
            <div class="id-badge-clean">#{{ variant.id }}</div>
          </td>
        </ng-container>

        <!-- Photos Column -->
        <ng-container matColumnDef="photos">
          <th mat-header-cell *matHeaderCellDef class="header-cell-clean">
            <div class="header-content-clean">
              <mat-icon class="header-icon">photo_library</mat-icon>
              <span>Photos</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let variant" class="data-cell-clean">
            <div
              class="photo-container-clean"
              *ngIf="hasValidImageUrls(variant.imageUrls); else noPhotoClean"
            >
              <div
                class="photo-preview-clean"
                (click)="openPhotoDialog(variant.imageUrls[0])"
              >
                <img [src]="variant.imageUrls[0]" alt="Product" />
                <div class="photo-overlay-clean">
                  <mat-icon>zoom_in</mat-icon>
                </div>
              </div>
              <div
                class="photo-counter-clean"
                *ngIf="variant.imageUrls.length > 1"
              >
                +{{ variant.imageUrls.length - 1 }}
              </div>
            </div>
            <ng-template #noPhotoClean>
              <div class="no-photo-clean">
                <mat-icon>image_not_supported</mat-icon>
              </div>
            </ng-template>
          </td>
        </ng-container>

        <!-- Price Column -->
        <ng-container matColumnDef="price">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            class="header-cell-clean"
          >
            <div class="header-content-clean">
              <mat-icon class="header-icon">attach_money</mat-icon>
              <span>Price</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let variant" class="data-cell-clean">
            <div class="price-display-clean">
              <span class="price-amount-clean">{{
                variant.price | number : "1.0-0"
              }}</span>
              <span class="price-currency-clean">MMK</span>
            </div>
          </td>
        </ng-container>

        <!-- Stock Column -->
        <ng-container matColumnDef="stock">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            class="header-cell-clean"
          >
            <div class="header-content-clean">
              <mat-icon class="header-icon">inventory_2</mat-icon>
              <span>Stock</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let variant" class="data-cell-clean">
            <div
              class="stock-badge-clean"
              [ngClass]="getStockClass(variant.stock)"
            >
              <div class="stock-dot-clean"></div>
              <span class="stock-number-clean">{{ variant.stock }}</span>
              <span class="stock-unit-clean">units</span>
            </div>
          </td>
        </ng-container>

        <!-- Attributes Column -->
        <ng-container matColumnDef="attributes">
          <th mat-header-cell *matHeaderCellDef class="header-cell-clean">
            <div class="header-content-clean">
              <mat-icon class="header-icon">tune</mat-icon>
              <span>Attributes</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let variant" class="data-cell-clean">
            <div class="attributes-list-clean">
              <div
                class="attribute-chip-clean"
                *ngFor="
                  let attr of variant.attributes | keyvalue | slice : 0 : 2
                "
              >
                <span class="attr-key-clean">{{ attr.key }}</span>
                <span class="attr-separator-clean">:</span>
                <span class="attr-value-clean">{{ attr.value }}</span>
              </div>
              <div
                class="more-attrs-clean"
                *ngIf="(variant.attributes | keyvalue).length > 2"
              >
                +{{ (variant.attributes | keyvalue).length - 2 }} more
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="header-cell-clean">
            <div class="header-content-clean">
              <mat-icon class="header-icon">settings</mat-icon>
              <span>Actions</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let variant" class="data-cell-clean">
            <div class="actions-group-clean">
              <span class="custom-tooltip-container">
                <button
                  mat-icon-button
                  (click)="editVariant(variant)"
                  class="action-icon-clean edit"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <span class="custom-tooltip">Edit Variant</span>
              </span>
              <span class="custom-tooltip-container">
                <button
                  mat-icon-button
                  (click)="addStock(variant)"
                  class="action-icon-clean add"
                >
                  <mat-icon>add_circle</mat-icon>
                </button>
                <span class="custom-tooltip">Add Stock</span>
              </span>
              <span class="custom-tooltip-container">
                <button
                  mat-icon-button
                  (click)="openReduceStockModal(variant)"
                  [disabled]="!hasStockToReduce(variant)"
                  class="action-icon-clean reduce"
                  [class.disabled]="!hasStockToReduce(variant)"
                >
                  <mat-icon>remove_circle</mat-icon>
                </button>
                <span class="custom-tooltip">{{
                  hasStockToReduce(variant)
                    ? "Reduce Stock"
                    : "No Stock to Reduce"
                }}</span>
              </span>
              <span class="custom-tooltip-container">
                <button
                  mat-icon-button
                  (click)="showHistory(variant)"
                  class="action-icon-clean history"
                >
                  <mat-icon>history</mat-icon>
                </button>
                <span class="custom-tooltip">View History</span>
              </span>
              <span class="custom-tooltip-container">
                <button
                  mat-icon-button
                  (click)="deleteVariant(variant)"
                  class="action-icon-clean delete"
                >
                  <mat-icon>delete</mat-icon>
                </button>
                <span class="custom-tooltip">Delete Variant</span>
              </span>
            </div>
          </td>
        </ng-container>

        <tr
          mat-header-row
          *matHeaderRowDef="displayedColumns"
          class="header-row-clean"
        ></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="data-row-clean"
        ></tr>

        <!-- No Data Row -->
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container-clean">
      <mat-paginator
        [pageSizeOptions]="[6, 12, 24]"
        [pageSize]="12"
        class="paginator-clean"
      ></mat-paginator>
    </div>
  </div>

  <!-- REDESIGNED MODALS -->

  <!-- Add Stock Modal -->
  <ng-template #addStockModal>
    <div class="modal-clean large">
      <div class="modal-header-clean">
        <div class="modal-title-section">
          <div class="modal-icon-clean add-stock">
            <mat-icon>add_shopping_cart</mat-icon>
          </div>
          <div class="modal-title-content">
            <h2 class="modal-title-clean">Add Stock</h2>
            <p class="modal-subtitle-clean">
              Variant #{{ selectedVariant?.id }}
            </p>
          </div>
        </div>
        <button mat-icon-button mat-dialog-close class="modal-close-clean">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body-clean">
        <form
          [formGroup]="stockForm"
          (ngSubmit)="saveStock()"
          class="form-clean"
        >
          <!-- Current Stock Info -->
          <div class="info-section-clean">
            <div class="info-header-clean">
              <mat-icon>inventory</mat-icon>
              <span>Current Inventory Status</span>
            </div>
            <div class="info-content-clean">
              <div class="current-stock-display">
                <span class="stock-value">{{ selectedVariant?.stock }}</span>
                <span class="stock-label">units currently in stock</span>
              </div>
            </div>
          </div>

          <!-- Form Fields -->
          <div class="form-section-clean">
            <div class="section-title-clean">
              <mat-icon>attach_money</mat-icon>
              <span>Pricing Information</span>
            </div>

            <div class="form-grid-clean">
              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>Previous Purchase Price (MMK)</mat-label>
                <input
                  matInput
                  type="number"
                  [value]="previousPurchasePrice"
                  disabled
                />
                <mat-icon matSuffix>history</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>New Purchase Price (MMK)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="purchasePrice"
                  required
                />
                <mat-icon matSuffix>shopping_cart</mat-icon>
                <mat-error
                  *ngIf="stockForm.get('purchasePrice')?.hasError('required')"
                  >Purchase price is required</mat-error
                >
                <mat-error
                  *ngIf="stockForm.get('purchasePrice')?.hasError('min')"
                  >Purchase price must be positive</mat-error
                >
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>New Selling Price (MMK)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="sellingPrice"
                  required
                />
                <mat-icon matSuffix>sell</mat-icon>
                <mat-error
                  *ngIf="stockForm.get('sellingPrice')?.hasError('required')"
                  >Selling price is required</mat-error
                >
                <mat-error
                  *ngIf="stockForm.get('sellingPrice')?.hasError('min')"
                  >Selling price must be positive</mat-error
                >
              </mat-form-field>

              <mat-form-field
                appearance="outline"
                class="form-field-clean quantity-field"
              >
                <mat-label>Additional Stock Quantity</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="quantity"
                  required
                />
                <mat-icon matSuffix>inventory_2</mat-icon>
                <mat-error
                  *ngIf="stockForm.get('quantity')?.hasError('required')"
                  >Quantity is required</mat-error
                >
                <mat-error *ngIf="stockForm.get('quantity')?.hasError('min')"
                  >Quantity must be positive</mat-error
                >
              </mat-form-field>
            </div>

            <!-- Preview -->
            <div
              class="preview-section-clean"
              *ngIf="stockForm.get('quantity')?.value > 0"
            >
              <div class="preview-header-clean">
                <mat-icon>preview</mat-icon>
                <span>Stock Preview</span>
              </div>
              <div class="preview-content-clean">
                <span class="preview-label">New Total Stock:</span>
                <span class="preview-value"
                  >{{
                    (selectedVariant?.stock || 0) +
                      (stockForm.get("quantity")?.value || 0)
                  }}
                  units</span
                >
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="modal-actions-clean">
            <button
              mat-stroked-button
              mat-dialog-close
              type="button"
              class="btn-cancel-clean"
            >
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            <button
              mat-flat-button
              color="primary"
              type="submit"
              [disabled]="stockForm.invalid || isUpdating"
              class="btn-save-clean"
            >
              <ng-container *ngIf="isUpdating">
                <mat-spinner
                  diameter="20"
                  class="btn-spinner-clean"
                ></mat-spinner>
                <span>Saving...</span>
              </ng-container>
              <ng-container *ngIf="!isUpdating">
                <span>Save Stock</span>
              </ng-container>
            </button>
          </div>
        </form>
      </div>
    </div>
  </ng-template>

  <!-- Add Variant Modal -->
  <ng-template #addVariantModal>
    <div class="modal-clean large">
      <div class="modal-header-clean">
        <div class="modal-title-section">
          <div class="modal-icon-clean add-variant">
            <mat-icon>add_box</mat-icon>
          </div>
          <div class="modal-title-content">
            <h2 class="modal-title-clean">Create New Variant</h2>
            <p class="modal-subtitle-clean">
              Add a new product variant with custom attributes
            </p>
          </div>
        </div>
        <button mat-icon-button mat-dialog-close class="modal-close-clean">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body-clean">
        <form
          [formGroup]="variantForm"
          (ngSubmit)="saveVariant()"
          class="form-clean"
        >
          <!-- Basic Information -->
          <div class="form-section-clean">
            <div class="section-title-clean">
              <mat-icon>info</mat-icon>
              <span>Basic Information</span>
            </div>

            <div class="form-grid-clean two-col">
              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>Price (MMK)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="price"
                  required
                />
                <mat-icon matSuffix>attach_money</mat-icon>
                <mat-error
                  *ngIf="variantForm.get('price')?.hasError('required')"
                  >Price is required</mat-error
                >
                <mat-error *ngIf="variantForm.get('price')?.hasError('min')"
                  >Price must be positive</mat-error
                >
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>Initial Stock</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="stock"
                  required
                />
                <mat-icon matSuffix>inventory</mat-icon>
                <mat-error
                  *ngIf="variantForm.get('stock')?.hasError('required')"
                  >Stock is required</mat-error
                >
                <mat-error *ngIf="variantForm.get('stock')?.hasError('min')"
                  >Stock must be positive</mat-error
                >
              </mat-form-field>
              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>Purchase Price (MMK)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="purchasePrice"
                  required
                />
                <mat-icon matSuffix>shopping_cart</mat-icon>
                <mat-error
                  *ngIf="variantForm.get('purchasePrice')?.hasError('required')"
                  >Purchase price is required</mat-error
                >
                <mat-error
                  *ngIf="variantForm.get('purchasePrice')?.hasError('min')"
                  >Purchase price must be positive</mat-error
                >
              </mat-form-field>
            </div>
          </div>

          <!-- Attributes -->
          <div class="form-section-clean">
            <div class="section-title-clean">
              <mat-icon>tune</mat-icon>
              <span>Variant Attributes</span>
              <button
                mat-icon-button
                type="button"
                (click)="addAttribute()"
                class="add-btn-clean"
              >
                <mat-icon>add_circle</mat-icon>
              </button>
            </div>

            <div formArrayName="attributes" class="attributes-container-clean">
              <div
                *ngFor="
                  let attributeGroup of attributesFormArray.controls;
                  let i = index;
                  trackBy: trackByAttribute
                "
                [formGroupName]="i"
                class="attribute-row-clean"
              >
                <mat-form-field appearance="outline" class="attr-field-clean">
                  <mat-label>Attribute Name</mat-label>
                  <input
                    matInput
                    formControlName="key"
                    placeholder="e.g., Color"
                    [readonly]="true"
                    [disabled]="true"
                  />
                  <mat-icon matSuffix>label</mat-icon>
                </mat-form-field>
                <mat-form-field appearance="outline" class="attr-field-clean">
                  <mat-label>Value</mat-label>
                  <input
                    matInput
                    formControlName="value"
                    placeholder="e.g., Red"
                  />
                  <mat-icon matSuffix>text_fields</mat-icon>
                </mat-form-field>
                <button
                  mat-icon-button
                  (click)="removeAttribute(i)"
                  class="remove-btn-clean"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <div
                class="empty-attributes-clean"
                *ngIf="attributesFormArray.length === 0"
              >
                <mat-icon class="empty-icon-clean">tune</mat-icon>
                <p>
                  No attributes added yet. Click the + button to add your first
                  attribute.
                </p>
              </div>
            </div>
          </div>

          <!-- Photos -->
          <div class="form-section-clean">
            <div class="section-title-clean">
              <mat-icon>photo_library</mat-icon>
              <span>Product Photos</span>
            </div>

            <div class="photo-section-clean">
              <div
                class="photos-grid-clean"
                *ngIf="displayImageUrls.length > 0"
              >
                <div
                  class="photo-item-clean"
                  *ngFor="let url of displayImageUrls; let i = index"
                >
                  <div class="photo-wrapper-clean">
                    <img [src]="url" alt="Preview" />
                    <div class="photo-actions-clean">
                      <button
                        mat-mini-fab
                        (click)="removePhoto(i)"
                        type="button"
                        class="remove-photo-clean"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="upload-area-clean" (click)="fileInput.click()">
                <input
                  #fileInput
                  type="file"
                  multiple
                  accept="image/*"
                  (change)="onFileSelected($event)"
                  style="display: none"
                />
                <div class="upload-content-clean">
                  <mat-icon class="upload-icon-clean">cloud_upload</mat-icon>
                  <h4>Upload Photos</h4>
                  <p>Click to browse or drag and drop images here</p>
                  <span class="upload-hint-clean"
                    >PNG, JPG, GIF up to 10MB each</span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="modal-actions-clean">
            <button
              mat-stroked-button
              (click)="cancelAddVariant()"
              type="button"
              class="btn-cancel-clean"
            >
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            <button
              mat-flat-button
              color="primary"
              type="submit"
              class="btn-save-clean"
            >
              <mat-icon>save</mat-icon>
              Create Variant
            </button>
          </div>
        </form>
      </div>
    </div>
  </ng-template>

  <!-- Edit Product Modal -->
  <ng-template #editProductModal>
    <div class="modal-clean">
      <div class="modal-header-clean">
        <div class="modal-title-section">
          <div class="modal-icon-clean edit-product">
            <mat-icon>edit</mat-icon>
          </div>
          <div class="modal-title-content">
            <h2 class="modal-title-clean">Edit Product</h2>
            <p class="modal-subtitle-clean">
              Update product information and settings
            </p>
          </div>
        </div>
        <button mat-icon-button mat-dialog-close class="modal-close-clean">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body-clean">
        <form
          [formGroup]="productForm"
          (ngSubmit)="saveProduct()"
          class="form-clean"
        >
          <!-- Product Details -->
          <div class="form-section-clean">
            <div class="section-title-clean">
              <mat-icon>inventory_2</mat-icon>
              <span>Product Details</span>
            </div>

            <div class="form-grid-clean">
              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>Brand</mat-label>
                <mat-select formControlName="brandId" required>
                  <mat-option [value]="null" disabled
                    >Select a brand</mat-option
                  >
                  <mat-option *ngFor="let brand of brands" [value]="brand.id">{{
                    brand.name
                  }}</mat-option>
                </mat-select>
                <mat-icon matSuffix>business</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>Product Name</mat-label>
                <input matInput formControlName="name" required />
                <mat-icon matSuffix>title</mat-icon>
                <mat-error *ngIf="productForm.get('name')?.hasError('required')"
                  >Name is required</mat-error
                >
              </mat-form-field>

              <mat-form-field
                appearance="outline"
                class="form-field-clean full-width"
              >
                <mat-label>Product Description</mat-label>
                <textarea
                  matInput
                  formControlName="description"
                  rows="4"
                  placeholder="Describe your product..."
                ></textarea>
                <mat-icon matSuffix>description</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>Product Rating (0-5)</mat-label>
                <input
                  matInput
                  type="number"
                  formControlName="rating"
                  min="0"
                  max="5"
                  step="0.1"
                />
                <mat-icon matSuffix>star</mat-icon>
                <mat-error
                  *ngIf="productForm.get('rating')?.hasError('required')"
                  >Rating is required</mat-error
                >
                <mat-error *ngIf="productForm.get('rating')?.hasError('min')"
                  >Minimum rating is 0</mat-error
                >
                <mat-error *ngIf="productForm.get('rating')?.hasError('max')"
                  >Maximum rating is 5</mat-error
                >
              </mat-form-field>
            </div>
          </div>

          <!-- Product Image -->
          <div class="form-section-clean">
            <div class="section-title-clean">
              <mat-icon>image</mat-icon>
              <span>Product Image</span>
            </div>

            <div class="image-section-clean">
              <div class="current-image-clean" *ngIf="basePhotoPreview">
                <img [src]="basePhotoPreview" alt="Product preview" />
                <div class="image-overlay-clean">
                  <button
                    mat-mini-fab
                    (click)="removeProductImage()"
                    type="button"
                    class="remove-image-clean"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>

              <div
                class="image-upload-clean"
                (click)="triggerProductImageUpload()"
              >
                <input
                  type="file"
                  id="basePhoto"
                  (change)="onBasePhotoSelected($event)"
                  accept="image/*"
                  style="display: none"
                  #productImageInput
                />
                <div class="upload-content-clean">
                  <mat-icon class="upload-icon-clean"
                    >add_photo_alternate</mat-icon
                  >
                  <h4>
                    {{ basePhotoPreview ? "Change Image" : "Upload Image" }}
                  </h4>
                  <p>Click to select a new product image</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="modal-actions-clean">
            <button
              mat-stroked-button
              type="button"
              mat-dialog-close
              class="btn-cancel-clean"
            >
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            <button
              mat-flat-button
              color="primary"
              type="submit"
              class="btn-save-clean"
            >
              <mat-icon>save</mat-icon>
              Save Product
            </button>
          </div>
        </form>
      </div>
    </div>
  </ng-template>

  <!-- Edit Variant Modal -->
  <ng-template #editVariantModal>
    <div class="modal-clean large">
      <div class="modal-header-clean">
        <div class="modal-title-section">
          <div class="modal-icon-clean edit-variant">
            <mat-icon>edit</mat-icon>
          </div>
          <div class="modal-title-content">
            <h2 class="modal-title-clean">Edit Variant</h2>
            <p class="modal-subtitle-clean">
              Variant #{{ editingVariant?.id }}
            </p>
          </div>
        </div>
        <button
          mat-icon-button
          mat-dialog-close="false"
          class="modal-close-clean"
        >
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body-clean">
        <form
          [formGroup]="variantForm"
          (ngSubmit)="updateVariant()"
          class="form-clean"
        >
          <!-- Basic Information -->
          <div class="form-section-clean">
            <div class="section-title-clean">
              <mat-icon>info</mat-icon>
              <span>Basic Information</span>
            </div>

            <div class="form-grid-clean two-col">
              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>SKU</mat-label>
                <input matInput [value]="editingVariant?.sku" disabled />
                <mat-icon matSuffix>qr_code</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="form-field-clean">
                <mat-label>Price (MMK)</mat-label>
                <input matInput type="number" formControlName="price" />
                <mat-icon matSuffix>attach_money</mat-icon>
              </mat-form-field>
            </div>

            <!-- Stock Info -->
            <div class="info-section-clean">
              <div class="info-header-clean">
                <mat-icon>inventory</mat-icon>
                <span>Current Stock: {{ editingVariant?.stock }} units</span>
              </div>
              <div class="info-content-clean">
                <p class="stock-note-clean">
                  Use the stock management buttons in the main table to adjust
                  inventory levels
                </p>
              </div>
            </div>
          </div>

          <!-- Attributes -->
          <div class="form-section-clean">
            <div class="section-title-clean">
              <mat-icon>tune</mat-icon>
              <span>Variant Attributes</span>
              <!-- Remove add attribute button in edit modal -->
            </div>

            <div formArrayName="attributes" class="attributes-container-clean">
              <div
                *ngFor="
                  let attributeGroup of attributesFormArray.controls;
                  let i = index;
                  trackBy: trackByAttribute
                "
                [formGroupName]="i"
                class="attribute-row-clean"
              >
                <mat-form-field appearance="outline" class="attr-field-clean">
                  <mat-label>Attribute Name</mat-label>
                  <input
                    matInput
                    formControlName="key"
                    [readonly]="true"
                    [disabled]="true"
                  />
                  <mat-icon matSuffix>label</mat-icon>
                </mat-form-field>
                <mat-form-field appearance="outline" class="attr-field-clean">
                  <mat-label>Value</mat-label>
                  <input matInput formControlName="value" />
                  <mat-icon matSuffix>text_fields</mat-icon>
                </mat-form-field>
                <!-- Remove delete attribute button in edit modal -->
              </div>
            </div>
          </div>

          <!-- Photos -->
          <div class="form-section-clean">
            <div class="section-title-clean">
              <mat-icon>photo_library</mat-icon>
              <span>Product Photos</span>
            </div>

            <div class="photo-section-clean">
              <div
                class="photos-grid-clean"
                *ngIf="displayImageUrls.length > 0"
              >
                <div
                  class="photo-item-clean"
                  *ngFor="let url of displayImageUrls; let i = index"
                >
                  <div class="photo-wrapper-clean">
                    <img [src]="url" alt="Preview" />
                    <div class="photo-actions-clean">
                      <button
                        mat-mini-fab
                        (click)="removePhoto(i)"
                        type="button"
                        class="remove-photo-clean"
                      >
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="upload-area-clean" (click)="fileInput.click()">
                <input
                  #fileInput
                  type="file"
                  multiple
                  accept="image/*"
                  (change)="onFileSelected($event)"
                  style="display: none"
                />
                <div class="upload-content-clean">
                  <mat-icon class="upload-icon-clean"
                    >add_photo_alternate</mat-icon
                  >
                  <h4>Add More Photos</h4>
                  <p>Click to browse additional images</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="modal-actions-clean">
            <button
              mat-stroked-button
              (click)="cancelEdit()"
              type="button"
              mat-dialog-close="false"
              [disabled]="isUpdating"
              class="btn-cancel-clean"
            >
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            <button
              mat-flat-button
              color="primary"
              type="submit"
              mat-dialog-close="true"
              [disabled]="isUpdating"
              class="btn-save-clean"
            >
              <ng-container *ngIf="isUpdating">
                <mat-spinner
                  diameter="20"
                  class="btn-spinner-clean"
                ></mat-spinner>
                <span>Updating...</span>
              </ng-container>
              <ng-container *ngIf="!isUpdating">
                <span>Update Variant</span>
              </ng-container>
            </button>
          </div>
        </form>
      </div>
    </div>
  </ng-template>

  <!-- Reduce Stock Modal -->
  <ng-template #reduceStockModal>
    <div class="modal-clean large">
      <div class="modal-header-clean">
        <div class="modal-title-section">
          <div class="modal-icon-clean reduce-stock">
            <mat-icon>remove_shopping_cart</mat-icon>
          </div>
          <div class="modal-title-content">
            <h2 class="modal-title-clean">Reduce Stock</h2>
            <p class="modal-subtitle-clean">
              Variant #{{ selectedVariant?.id }}
            </p>
          </div>
        </div>
        <button mat-icon-button mat-dialog-close class="modal-close-clean">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-body-clean">
        <form
          [formGroup]="reduceStockForm"
          (ngSubmit)="submitReduceStock()"
          class="form-clean"
        >
          <!-- Current Stock Info -->
          <div class="info-section-clean">
            <div class="info-header-clean">
              <mat-icon>inventory</mat-icon>
              <span>Current Stock: {{ selectedVariant?.stock }} units</span>
            </div>
            <div class="info-content-clean">
              <p class="stock-note-clean">
                Select quantities to reduce from each purchase batch below
              </p>
            </div>
          </div>

          <!-- Reduction Table -->
          <div class="reduction-section-clean">
            <div class="section-title-clean">
              <mat-icon>list</mat-icon>
              <span>Purchase Batches</span>
            </div>

            <div class="reduction-items-clean">
              <div
                class="reduction-item-clean"
                *ngFor="
                  let group of reductionsFormArray.controls;
                  let i = index
                "
              >
                <div class="batch-info-clean">
                  <div class="batch-detail">
                    <mat-icon>attach_money</mat-icon>
                    <span class="batch-price-clean"
                      >{{ purchaseHistory[i].purchasePrice | number }} MMK</span
                    >
                  </div>
                  <div class="batch-detail">
                    <mat-icon>inventory</mat-icon>
                    <span
                      >{{
                        purchaseHistory[i].remainingQuantity
                      }}
                      available</span
                    >
                  </div>
                  <div class="batch-detail">
                    <mat-icon>schedule</mat-icon>
                    <span>{{
                      purchaseHistory[i].purchaseDate | date : "MMM dd, yyyy"
                    }}</span>
                  </div>
                </div>

                <div class="reduction-controls-clean">
                  <button
                    mat-mini-fab
                    (click)="decrementReduction(i)"
                    type="button"
                    [disabled]="group.get('quantity')?.value <= 0"
                    class="control-btn-clean decrease"
                  >
                    <mat-icon>remove</mat-icon>
                  </button>

                  <div class="quantity-input-clean">
                    <input
                      matInput
                      type="number"
                      min="0"
                      [max]="purchaseHistory[i].remainingQuantity"
                      [formControl]="getQuantityControl(group)"
                      class="quantity-field-clean"
                    />
                  </div>

                  <button
                    mat-mini-fab
                    (click)="
                      incrementReduction(
                        i,
                        purchaseHistory[i].remainingQuantity
                      )
                    "
                    type="button"
                    [disabled]="
                      group.get('quantity')?.value >=
                      purchaseHistory[i].remainingQuantity
                    "
                    class="control-btn-clean increase"
                  >
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Reduction Reason -->
          <div class="reason-section-clean">
            <div class="section-title-clean">
              <mat-icon>help_outline</mat-icon>
              <span>Reduction Reason</span>
            </div>
            <mat-form-field
              appearance="outline"
              class="form-field-clean full-width"
            >
              <mat-label>Select reduction reason</mat-label>
              <mat-select formControlName="reductionReason">
                <mat-option
                  *ngFor="let reason of commonReductionReasons"
                  [value]="reason"
                >
                  {{ reason }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>list</mat-icon>
              <mat-error
                *ngIf="
                  reduceStockForm.get('reductionReason')?.hasError('required')
                "
                >Reason is required</mat-error
              >
            </mat-form-field>

            <!-- Custom reason field - only show when "Other" is selected -->
            <mat-form-field
              *ngIf="showCustomReasonField()"
              appearance="outline"
              class="form-field-clean full-width"
            >
              <mat-label>Please specify the reason</mat-label>
              <textarea
                matInput
                formControlName="customReason"
                rows="3"
                placeholder="Please provide details about the reduction reason..."
              ></textarea>
              <mat-icon matSuffix>description</mat-icon>
              <mat-error
                *ngIf="
                  reduceStockForm.get('customReason')?.hasError('required')
                "
                >Custom reason is required</mat-error
              >
            </mat-form-field>
          </div>

          <!-- Summary -->
          <div class="summary-section-clean">
            <div class="summary-header-clean">
              <mat-icon>calculate</mat-icon>
              <span>Reduction Summary</span>
            </div>
            <div class="summary-content-clean">
              <div class="summary-row-clean">
                <span class="summary-label-clean">Total to reduce:</span>
                <span class="summary-value-clean"
                  >{{ getTotalReduction() }} units</span
                >
              </div>
              <div class="summary-row-clean">
                <span class="summary-label-clean"
                  >Remaining after reduction:</span
                >
                <span class="summary-value-clean"
                  >{{
                    (selectedVariant?.stock ?? 0) - getTotalReduction()
                  }}
                  units</span
                >
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="modal-actions-clean">
            <button
              mat-stroked-button
              mat-dialog-close
              type="button"
              class="btn-cancel-clean"
            >
              <mat-icon>close</mat-icon>
              Cancel
            </button>
            <button
              mat-flat-button
              color="warn"
              type="submit"
              class="btn-reduce-clean"
              [disabled]="
                reduceStockForm.invalid ||
                getTotalReduction() === 0 ||
                getTotalReduction() > (selectedVariant?.stock ?? 0)
              "
            >
              <ng-container *ngIf="isReducing">
                <mat-spinner
                  diameter="20"
                  class="btn-spinner-clean"
                ></mat-spinner>
                <span>Reducing...</span>
              </ng-container>
              <ng-container *ngIf="!isReducing">
                <span>Reduce Stock</span>
              </ng-container>
            </button>
          </div>
        </form>
      </div>
    </div>
  </ng-template>
</div>

<!-- Custom History Modal Overlay -->
<div *ngIf="showCustomHistoryModal" class="custom-modal-overlay">
  <div class="custom-modal-box">
    <button class="custom-modal-close" (click)="closeCustomHistoryModal()">
      &times;
    </button>
    <div class="modal-header-clean">
      <div class="modal-title-section">
        <div class="modal-icon-clean history">
          <mat-icon>history</mat-icon>
        </div>
        <div class="modal-title-content">
          <h2 class="modal-title-clean">Variant History</h2>
          <p class="modal-subtitle-clean">
            Variant #{{ selectedVariantForHistory?.id }}
          </p>
        </div>
      </div>
    </div>
    <div class="modal-body-clean history-body">
      <div class="history-tabs-clean">
        <div
          class="tab-clean"
          [class.active]="activeHistoryTab === 'price'"
          (click)="setActiveHistoryTab('price')"
        >
          <mat-icon>sell</mat-icon>
          <span>Price History</span>
        </div>
        <div
          class="tab-clean"
          [class.active]="activeHistoryTab === 'purchase'"
          (click)="setActiveHistoryTab('purchase')"
        >
          <mat-icon>shopping_cart</mat-icon>
          <span>Purchase History</span>
        </div>
        <div
          class="tab-clean"
          [class.active]="activeHistoryTab === 'reduce'"
          (click)="setActiveHistoryTab('reduce')"
        >
          <mat-icon>remove_shopping_cart</mat-icon>
          <span>Reduce Stock History</span>
        </div>
        <div
          class="tab-clean"
          [class.active]="activeHistoryTab === 'edit'"
          (click)="setActiveHistoryTab('edit')"
        >
          <mat-icon>edit</mat-icon>
          <span>Edit History</span>
        </div>
      </div>
      <div class="history-content-clean">
        <!-- Price History -->
        <div class="history-section-clean" *ngIf="activeHistoryTab === 'price'">
          
          <div class="section-title-clean">
            <mat-icon>trending_up</mat-icon>
            <span>Selling Price History</span>
            <div class="export-btn-row right-align" style="position: relative">
            <button
              class="panel-btn"
              (click)="showExportDropdownPrice = !showExportDropdownPrice"
              aria-label="Export options"
              style="margin-right: 0"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                <polyline points="7,10 12,15 17,10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
            </button>
            <div
              *ngIf="showExportDropdownPrice"
              class="custom-export-dropdown"
              (mouseleave)="showExportDropdownPrice = false"
            >
              <button
                (click)="
                  exportPriceHistoryPDF(); showExportDropdownPrice = false
                "
              >
                <mat-icon>picture_as_pdf</mat-icon> Export as PDF
              </button>
              <button
                (click)="
                  exportPriceHistoryExcel(); showExportDropdownPrice = false
                "
              >
                <mat-icon>table_view</mat-icon> Export as Excel
              </button>
            </div>
          </div>

          </div>

          <div class="history-table-clean">
            <table
              mat-table
              [dataSource]="priceHistoryDataSource"
              matSort
              #priceSort="matSort"
              [matSortActive]="'date'"
              [matSortDirection]="'desc'"
              class="data-table-clean"
            >
              <ng-container matColumnDef="price">
                <th
                  mat-header-cell
                  *matHeaderCellDef
                  mat-sort-header
                  class="header-cell-clean"
                >
                  <div class="header-content-clean">
                    <mat-icon class="header-icon">attach_money</mat-icon>
                    <span>Price</span>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row" class="data-cell-clean">
                  <div class="price-display-clean">
                    <span class="price-amount-clean">{{ row.price }}</span>
                    <span class="price-currency-clean">MMK</span>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="date">
                <th
                  mat-header-cell
                  *matHeaderCellDef
                  mat-sort-header
                  class="header-cell-clean"
                >
                  <div class="header-content-clean">
                    <mat-icon class="header-icon">schedule</mat-icon>
                    <span>Date</span>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row" class="data-cell-clean">
                  {{ row.priceDate | date : "MMM dd, yyyy HH:mm" }}
                </td>
              </ng-container>

              <ng-container matColumnDef="admin">
                <th mat-header-cell *matHeaderCellDef class="header-cell-clean">
                  <div class="header-content-clean">
                    <mat-icon class="header-icon">person</mat-icon>
                    <span>Admin</span>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row" class="data-cell-clean">
                  {{ row.adminName || "N/A" }} ({{ row.adminId }})
                </td>
              </ng-container>

              <tr
                mat-header-row
                *matHeaderRowDef="['price', 'date', 'admin']"
                class="header-row-clean"
              ></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: ['price', 'date', 'admin']"
                class="data-row-clean"
              ></tr>

              <tr
                *ngIf="priceHistoryDataSource.data.length === 0"
                class="empty-row-clean"
              >
                <td colspan="3" class="empty-cell-clean">
                  <div class="empty-state-clean">
                    <mat-icon>trending_flat</mat-icon>
                    <p>No price history available</p>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Purchase History -->
        <div
          class="history-section-clean"
          *ngIf="activeHistoryTab === 'purchase'"
        >
          
          <div class="section-title-clean">
            <mat-icon>shopping_basket</mat-icon>
            <span>Purchase History</span>
            <div class="export-btn-row right-align" style="position: relative">
            <button
              class="panel-btn"
              (click)="showExportDropdownPurchase = !showExportDropdownPurchase"
              aria-label="Export options"
              style="margin-right: 0"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                <polyline points="7,10 12,15 17,10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
            </button>
            <div
              *ngIf="showExportDropdownPurchase"
              class="custom-export-dropdown"
              (mouseleave)="showExportDropdownPurchase = false"
            >
              <button
                (click)="
                  exportPurchaseHistoryPDF(); showExportDropdownPurchase = false
                "
              >
                <mat-icon>picture_as_pdf</mat-icon> Export as PDF
              </button>
              <button
                (click)="
                  exportPurchaseHistoryExcel();
                  showExportDropdownPurchase = false
                "
              >
                <mat-icon>table_view</mat-icon> Export as Excel
              </button>
            </div>
          </div>
          </div>

          <div class="history-table-clean">
            <table
              mat-table
              [dataSource]="purchaseHistoryDataSource"
              matSort
              #purchaseSort="matSort"
              [matSortActive]="'date'"
              [matSortDirection]="'desc'"
              class="data-table-clean"
            >
              <ng-container matColumnDef="batchId">
                <th mat-header-cell *matHeaderCellDef class="header-cell-clean">
                  <div class="header-content-clean">
                    <mat-icon class="header-icon">confirmation_number</mat-icon>
                    <span>Batch ID</span>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row" class="data-cell-clean">
                  <span class="batch-id">#{{ row.id }}</span>
                </td>
              </ng-container>
              <ng-container matColumnDef="purchasePrice">
                <th
                  mat-header-cell
                  *matHeaderCellDef
                  mat-sort-header
                  class="header-cell-clean"
                >
                  <div class="header-content-clean">
                    <mat-icon class="header-icon">shopping_cart</mat-icon>
                    <span>Purchase Price</span>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row" class="data-cell-clean">
                  <div class="price-display-clean">
                    <span class="price-amount-clean">{{
                      row.purchasePrice
                    }}</span>
                    <span class="price-currency-clean">MMK</span>
                  </div>
                </td>
              </ng-container>
              <ng-container matColumnDef="quantity">
                <th mat-header-cell *matHeaderCellDef class="header-cell-clean">
                  <div class="header-content-clean">
                    <mat-icon class="header-icon">inventory_2</mat-icon>
                    <span>Quantity</span>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row" class="data-cell-clean">
                  <div class="quantity-badge-clean">{{ row.quantity }}</div>
                </td>
              </ng-container>
              <ng-container matColumnDef="remaining">
                <th mat-header-cell *matHeaderCellDef class="header-cell-clean">
                  <div class="header-content-clean">
                    <mat-icon class="header-icon">inventory</mat-icon>
                    <span>Remaining</span>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row" class="data-cell-clean">
                  <div
                    class="remaining-badge-clean"
                    [class.low]="row.remainingQuantity <= 5"
                  >
                    {{ row.remainingQuantity }}
                  </div>
                </td>
              </ng-container>
              <ng-container matColumnDef="date">
                <th
                  mat-header-cell
                  *matHeaderCellDef
                  mat-sort-header
                  class="header-cell-clean"
                >
                  <div class="header-content-clean">
                    <mat-icon class="header-icon">schedule</mat-icon>
                    <span>Date</span>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row" class="data-cell-clean">
                  {{ row.purchaseDate | date : "MMM dd, yyyy HH:mm" }}
                </td>
              </ng-container>
              <ng-container matColumnDef="admin">
                <th mat-header-cell *matHeaderCellDef class="header-cell-clean">
                  <div class="header-content-clean">
                    <mat-icon class="header-icon">person</mat-icon>
                    <span>Admin</span>
                  </div>
                </th>
                <td mat-cell *matCellDef="let row" class="data-cell-clean">
                  {{ row.adminName || "N/A" }}
                  <span *ngIf="row.adminId">({{ row.adminId }})</span>
                </td>
              </ng-container>
              <tr
                mat-header-row
                *matHeaderRowDef="[
                  'batchId',
                  'purchasePrice',
                  'quantity',
                  'remaining',
                  'date',
                  'admin'
                ]"
                class="header-row-clean"
              ></tr>
              <tr
                mat-row
                *matRowDef="
                  let row;
                  columns: [
                    'batchId',
                    'purchasePrice',
                    'quantity',
                    'remaining',
                    'date',
                    'admin'
                  ]
                "
                class="data-row-clean"
              ></tr>
              <tr
                *ngIf="purchaseHistoryDataSource.data.length === 0"
                class="empty-row-clean"
              >
                <td colspan="6" class="empty-cell-clean">
                  <div class="empty-state-clean">
                    <mat-icon>shopping_basket</mat-icon>
                    <p>No purchase history available</p>
                  </div>
                </td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Reduce Stock History -->
        <div
          class="history-section-clean"
          *ngIf="activeHistoryTab === 'reduce'"
        >
          
          <div class="section-title-clean">
            <mat-icon>remove_shopping_cart</mat-icon>
            <span>Reduce Stock History</span>
            <div class="export-btn-row right-align" style="position: relative">
            <button
              class="panel-btn"
              (click)="showExportDropdownReduce = !showExportDropdownReduce"
              aria-label="Export options"
              style="margin-right: 0"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                <polyline points="7,10 12,15 17,10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
            </button>
            <div
              *ngIf="showExportDropdownReduce"
              class="custom-export-dropdown"
              (mouseleave)="showExportDropdownReduce = false"
            >
              <button
                (click)="
                  exportReduceStockHistoryPDF();
                  showExportDropdownReduce = false
                "
              >
                <mat-icon>picture_as_pdf</mat-icon> Export as PDF
              </button>
              <button
                (click)="
                  exportReduceStockHistoryExcel();
                  showExportDropdownReduce = false
                "
              >
                <mat-icon>table_view</mat-icon> Export as Excel
              </button>
            </div>
          </div>
          </div>

          <div class="history-table-clean">
            <table class="data-table-clean">
              <thead>
                <tr class="header-row-clean">
                  <th>Reduction Reason</th>
                  <th>Admin</th>
                  <th>Admin ID</th>
                  <th>Date</th>
                  <th>Stock Change</th>
                  <th>Details (Batches)</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let group of groupedReduceStockHistory">
                  <td>
                    <div class="reason-text-clean">
                      {{ group.reductionReason }}
                    </div>
                  </td>
                  <td>{{ group.adminName || "N/A" }}</td>
                  <td>{{ group.adminId || "N/A" }}</td>
                  <td>{{ group.reducedAt | date : "MMM dd, yyyy HH:mm" }}</td>
                  <td>
                    <span class="before-clean"
                      >{{ group.totalStockBeforeReduction }} →
                      {{ group.totalStockAfterReduction }}</span
                    >
                  </td>
                  <td>
                    <ul style="margin: 0; padding-left: 1em">
                      <li *ngFor="let row of group.rows">
                        <span class="batch-id"
                          >Batch #{{ row.purchaseHistoryId }}</span
                        >
                        <span class="batch-qty"
                          >Quantity: {{ row.quantityReduced }}</span
                        >
                        <span class="batch-price"
                          >Purchase Price:
                          {{ row.purchasePriceAtReduction }} MMK</span
                        >
                      </li>
                    </ul>
                  </td>
                </tr>
                <tr
                  *ngIf="groupedReduceStockHistory.length === 0"
                  class="empty-row-clean"
                >
                  <td colspan="6" class="empty-cell-clean">
                    <div class="empty-state-clean">
                      <mat-icon>remove_shopping_cart</mat-icon>
                      <p>No reduce stock history available</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- Edit History -->
        <div class="history-section-clean" *ngIf="activeHistoryTab === 'edit'">
          <div class="section-title-clean">
            <mat-icon>edit</mat-icon>
            <span>Edit History</span>
          </div>
          <div class="history-table-clean">
            <table class="data-table-clean">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Field</th>
                  <th>Action</th>
                  <th>Old Value</th>
                  <th>New Value</th>
                  <th>Changed By</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let history of variantEditHistory">
                  <td>{{ history.createdAt | date : "MMM dd, yyyy HH:mm" }}</td>
                  <td>{{ formatFieldName(history.fieldName) }}</td>
                  <td>
                    <span
                      class="action-badge"
                      [class]="'action-' + history.action.toLowerCase()"
                    >
                      {{ history.action }}
                    </span>
                  </td>
                  <td>
                    <ng-container *ngIf="history.fieldName === 'photo'">
                      <img
                        [src]="history.oldValue"
                        *ngIf="history.oldValue"
                        style="
                          max-width: 60px;
                          max-height: 60px;
                          object-fit: cover;
                          border-radius: 4px;
                        "
                      />
                      <span *ngIf="!history.oldValue" class="no-value"
                        >N/A</span
                      >
                    </ng-container>
                    <span *ngIf="history.fieldName !== 'photo'">{{
                      history.oldValue || "N/A"
                    }}</span>
                  </td>
                  <td>
                    <ng-container *ngIf="history.fieldName === 'photo'">
                      <img
                        [src]="history.newValue"
                        *ngIf="history.newValue"
                        style="
                          max-width: 60px;
                          max-height: 60px;
                          object-fit: cover;
                          border-radius: 4px;
                        "
                      />
                      <span *ngIf="!history.newValue" class="no-value"
                        >N/A</span
                      >
                    </ng-container>
                    <span *ngIf="history.fieldName !== 'photo'">{{
                      history.newValue || "N/A"
                    }}</span>
                  </td>
                  <td>{{ history.adminName || "N/A" }}</td>
                </tr>
                <tr *ngIf="variantEditHistory.length === 0">
                  <td colspan="6">
                    <div class="empty-state-center">
                      <mat-icon>history</mat-icon>
                      <p>No edit history available</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Product History Modal -->
<ng-template #productHistoryModal>
  <div class="modal-clean large">
    <div class="modal-header-clean">
      <div class="modal-title-section">
        <div class="modal-icon-clean product-history">
          <mat-icon>history</mat-icon>
        </div>
        <div class="modal-title-content">
          <h2 class="modal-title-clean">Product History</h2>
          <p class="modal-subtitle-clean">
            {{ product?.name }} - Change History
          </p>
        </div>
      </div>
      <button mat-icon-button mat-dialog-close class="modal-close-clean">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body-clean">
      <div class="history-content-clean">
        <div class="history-table-clean">
          <table class="data-table-clean">
            <thead>
              <tr class="header-row-clean">
                <th>Date</th>
                <th>Action</th>
                <th>Field</th>
                <th>Changed By</th>
                <th>Old Value</th>
                <th>New Value</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let history of filteredProductHistory">
                <td>{{ history.createdAt | date : "MMM dd, yyyy HH:mm" }}</td>
                <td>
                  <span
                    class="action-badge-clean"
                    [class]="'action-' + history.action.toLowerCase()"
                  >
                    {{ history.action }}
                  </span>
                </td>
                <td>{{ formatFieldName(history.fieldName) }}</td>
                <td>{{ history.adminName || "Unknown" }}</td>
                <td>
                  <ng-container
                    *ngIf="
                      history.fieldName === 'base_photo' && history.oldValue;
                      else oldValueText
                    "
                  >
                    <img
                      [src]="history.oldValue"
                      alt="Old Base Photo"
                      style="
                        max-width: 80px;
                        max-height: 80px;
                        border-radius: 6px;
                        border: 1px solid #eee;
                      "
                    />
                  </ng-container>
                  <ng-template #oldValueText>
                    <ng-container
                      *ngIf="
                        history.fieldName === 'description';
                        else oldValueTextPlain
                      "
                    >
                      <div class="desc-diff-box">
                        <span
                          class="old-value-clean"
                          [innerHTML]="
                            getDescriptionDiff(
                              history.oldValue,
                              history.newValue,
                              'old'
                            )
                          "
                        ></span>
                      </div>
                    </ng-container>
                    <ng-template #oldValueTextPlain>
                      <span class="old-value-clean">{{
                        history.oldValue || "N/A"
                      }}</span>
                    </ng-template>
                  </ng-template>
                </td>
                <td>
                  <ng-container
                    *ngIf="
                      history.fieldName === 'base_photo' && history.newValue;
                      else newValueText
                    "
                  >
                    <img
                      [src]="history.newValue"
                      alt="New Base Photo"
                      style="
                        max-width: 80px;
                        max-height: 80px;
                        border-radius: 6px;
                        border: 1px solid #eee;
                      "
                    />
                  </ng-container>
                  <ng-template #newValueText>
                    <ng-container
                      *ngIf="
                        history.fieldName === 'description';
                        else newValueTextPlain
                      "
                    >
                      <div class="desc-diff-box">
                        <span
                          class="new-value-clean"
                          [innerHTML]="
                            getDescriptionDiff(
                              history.oldValue,
                              history.newValue,
                              'new'
                            )
                          "
                        ></span>
                      </div>
                    </ng-container>
                    <ng-template #newValueTextPlain>
                      <span class="new-value-clean">{{
                        history.newValue || "N/A"
                      }}</span>
                    </ng-template>
                  </ng-template>
                </td>
              </tr>
              <tr
                *ngIf="filteredProductHistory.length === 0"
                class="empty-row-clean"
              >
                <td colspan="6" class="empty-cell-clean">
                  <div class="empty-state-clean">
                    <mat-icon>history</mat-icon>
                    <p>No history available for this product</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</ng-template>
